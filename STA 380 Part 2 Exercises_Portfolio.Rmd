---
title: 'STA 380, Part 2: Exercises'
author: "Brandt"
date: "8/5/2021"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# output:
#   md_document:
#     variant: markdown_github

```



```{r, include=FALSE}
# Load libraries
set.seed(42)
library(readr)
library(dplyr)
library(tidyverse)
library(ggcorrplot)
library(moments)

library(mosaic)
library(quantmod)
library(foreach)
```

# Portfolio modeling

We are using 8 ETFs as a our feasible set for portfolio construction:


* US Equities:
  + ARK: ARK Innovation ETF.
  + SDY: S&P 500 High Yield Dividend Aristocrats
  + XLF: Diversified, financial equities
* Fixed Income:
  + GOT: US Treasuries
  + HYG: US high yield, liquid, corporate bonds
* Foreign Equities:
  + EWJ: Large cap Japanese Stocks
  + MCHI: Chinese Equity Market
* Commodity
  + BNO: Brent Crude Oil

```{r, include=FALSE}
# Load data from web


# Get ETs
my_etfs = c("ARKK", "SDY", "GOVT",'BNO','EWJ','XLF','MCHI','HYG')
etf_count = length(my_etfs) # Need this later

# 5 years of data
getSymbols(my_etfs,from='2016-8-1')


# We want to look at adjusted values only
for(ticker in my_etfs) {
  expr = paste0(ticker, "a = adjustOHLC(", ticker, ")")
  eval(parse(text=expr))
}

my_etfs_adjusted = paste(my_etfs,'a',sep = '')

all_returns = cbind( ClCl(ARKKa),
                     ClCl(SDYa),
                     ClCl(XLFa),
                     ClCl(GOVTa),
                     ClCl(HYGa),
                     ClCl(EWJa),
                     ClCl(MCHIa),
                     ClCl(BNOa))

all_returns = as.matrix(na.omit(all_returns))

```

## Portfolios
From the 8 ETFs listed, we defined three portfolios:

* Equal Weight
  + This portfolio holds all 8 ETFs in equal proportions. 
* Bond Heavy
  + This portfolio consists allocates 40% to each of the two bond funds (GOT & HYG) and spreads the remaining 20% out equally among the remaining 6 ETFS.
* Foreign Heavy
  + This portfolio consists allocates 40% to each of the two non-US equity funds (EWJ & MCHI) and spreads the remaining 20% out equally among the remaining 6 ETFS.
  

The equal weight portfolio is chosen as it simply represents our default approach. We do not have opinions on the future returns of the ETFs so we would default to equal weighting all securities. We include the foreign-heavy portfolio because we would like to understand how our portfolio turns out if we decide to express the view that Chinese and Japanese equities will outperform US Equities. Last, we expect that the bond-heavy portfolio will be the safer choice, producing the lowest losses, but providing the least returns. This 'safe' portfolio is included because we want to understand the portfolio dynamics if we decide to invest conservatively.

```{r, include=FALSE}
# Create 3 portfolios.

# Equal weighted /no opinion portfolio
allocation_equal = rep(1/etf_count,etf_count)


# Create bond allocation. 80% in two bond funds. Equal weight placed in the remaining
bond_allocation = .8
non_bond = (1-bond_allocation)/6
allocation_bond_heavy = rep(non_bond,etf_count)
allocation_bond_heavy[c(4,5)] = bond_allocation/2


# Foreign Heavy
foreign_allocation = .8
non_foreign = (1-foreign_allocation)/6
allocation_foreign = rep(non_foreign,etf_count)
allocation_foreign[c(6,7)] = foreign_allocation/2


# Compile three portfolios in a matrix
portfolio_weights = as.data.frame(cbind(allocation_equal,allocation_bond_heavy,allocation_foreign))

# Make sure each of the allocations sum to one
colSums(portfolio_weights) == 1

```

## Simulation

We perform a bootstrap simulation by randomly sampling the historical, joint probability distribution of our 8 ETFs. The parameters of the simulation are listed below:

**Parameter** | **Assumption**
----------|-----------
Initial Capital | \$100,000
Days Per Simulation | 20
Number of Simulations | 10,000 


```{r}
# Run the simulation!


# Simulation Parameters
initial_capital = 100000
days_in_simulation = 20
simulation_count = 10000



# all_ending_wealths = rep(0,simulation_count) # matrix to store ending wealths

# Create 3 matrices to store the daily wealths of each portfolio
# These will be 10,000 X 20 dim matrices
equal_weight_wealths = data.frame(matrix(rep(0,days_in_simulation* simulation_count),nrow=simulation_count,ncol=days_in_simulation))
bondy_heavy_wealths = data.frame(matrix(rep(0,days_in_simulation* simulation_count),nrow=simulation_count,ncol=days_in_simulation))
foreign_heavy_wealths = data.frame(matrix(rep(0,days_in_simulation* simulation_count),nrow=simulation_count,ncol=days_in_simulation))


for (simulation_num in 1:simulation_count) {
  
  # 3 Vectors containing the dollar value holding of each ETF 
  equal_weight_port = portfolio_weights$allocation_equal * initial_capital
  bond_heavy_port = portfolio_weights$allocation_bond_heavy * initial_capital
  foreign_heavy_port = portfolio_weights$allocation_foreign * initial_capital  
  
  
  for (day_num in 1:days_in_simulation) {
    returns = resample(all_returns,1) # Sample returns
    
    # Calculate ending wealths after each day
    equal_weight_port = equal_weight_port + equal_weight_port * returns
    bond_heavy_port = bond_heavy_port + bond_heavy_port * returns
    foreign_heavy_port = foreign_heavy_port + foreign_heavy_port * returns
    
    # Record the wealths for each portfolio at that point in time
    equal_weight_wealths[simulation_num,day_num] = sum(equal_weight_port)
    bondy_heavy_wealths[simulation_num,day_num] = sum(bond_heavy_port)
    foreign_heavy_wealths[simulation_num,day_num] = sum(foreign_heavy_port)
    
    # Re balance each portfolio
    equal_weight_port = sum(equal_weight_port) * portfolio_weights$allocation_equal
    bond_heavy_port = sum(bond_heavy_port) * portfolio_weights$allocation_bond_heavy
    foreign_heavy_port = sum(foreign_heavy_port) * portfolio_weights$allocation_foreign
    
  }

}

# Create an data frame containing info for all portfolios. This makes plotting easier with ggplot.
equal_weight_wealths$Type = 'Equal Weight'
foreign_heavy_wealths$Type = 'Foreign Heavy'
bondy_heavy_wealths$Type = 'Bondy Heavy'

all_ending_wealths = rbind(equal_weight_wealths,bondy_heavy_wealths)
all_ending_wealths = rbind(all_ending_wealths,foreign_heavy_wealths)

```
```{r}

# # Create an data frame containing info for all portfolios. This makes plotting easier with ggplot.
# equal_weight_wealths$Type = 'Equal Weight'
# foreign_heavy_wealths$Type = 'Foreign Heavy'
# bondy_heavy_wealths$Type = 'Bondy Heavy'
# 
# all_ending_wealths = rbind(equal_weight_wealths,bondy_heavy_wealths)
# all_ending_wealths = rbind(all_ending_wealths,foreign_heavy_wealths)
```
## Simulation Results
The results of the simulation are about in line with what you would expect. The foreign-heavy portfolio appears to be the riskiest, while offering the highest potential for return. The equal weight and bond-heavy portfolios offer lower expected wealth, but provide less variability in the potential outcome. We can now examine some plots and summary statistics to better understand the portfolios

### Ending Wealth Distribution
As a first look, we examine the distribution of endings wealth by portfolio. This gives us a quick and intuitive feel for what our portfolios could look like at the end of the 20 day period. The blue line below indicates the position of our starting wealth of \$ 100,000. This gives us a baseline to compare the rest of the results too by highlighting the result if we did not invest in anything. In all three portfolios there is a significant portion of the distribution to the left of this line! If you are horrified by the idea of capital loss, these investments may not be for you.

One additional point worth noting here is that the equal weight portfolio appears to have a similar distribution to the foreign heavy portfolio, except the equal weight portfolio does not suffer from the extreme left tail possibilities as the foreign heavy does. This is simply a consequence of effective diversification. The foreign heavy portfolio is heavily allocated to the Chinese and Japanese markets. In periods where those economies perform poorly, this portfolio will perform poorly.

```{r}


all_ending_wealths %>%  ggplot(aes(x=X20)) + geom_histogram(fill='white', color='black', bins = 50) + facet_grid(Type ~.,scales = 'free') + geom_vline(xintercept = 100000, size=1,color='blue')+ scale_x_continuous(labels = scales::dollar_format()) + labs(title='Distribution of Ending Wealths By Portfolio')


```

### Profits and Summary Statistics
After looking at the big picture, we can dive in further to get a more complete understanding of our portfolios. First, we plot the distribution of ending portfolio profits. These histograms are nearly identical to the total ending wealth distributions we just looked at, but these present the same information as a relative metric. Perhaps you want to understand your expected dollar profit from each portfolio. You can see this below:  
```{r}
# Var

all_ending_wealths$profit = all_ending_wealths$X20 - initial_capital


ggplot(all_ending_wealths,aes(profit)) + geom_histogram(fill='white', color='black', bins = 50) + facet_grid(Type ~.,scales = 'free') + scale_x_continuous(labels = scales::dollar_format()) + labs(title='Distribution of Ending Profits By Portfolio')

```


Next, we provide summary statistics for how the portfolios performed across the simulations:
```{r}


summary_stats = all_ending_wealths %>% group_by(Type) %>% summarise(VAR_.05 = quantile(profit,prob=.05), Minimum_Profit = min(profit),Max_Profit = max(profit), Average_Profit= mean(profit), MAD = mad(profit), Range = max(profit)-min(profit))

knitr::kable(summary_stats,caption = "Summary Stats for Portfolio Profits", digits = 2,format.args = list(big.mark = ",",
  scientific = FALSE))
```
There is a lot of information to unpack from the table above.


* VAR: The 5% value at risk for each portfolio tells us the amount we can expect to lose *at least* 5% of the time. This is helpful in understanding the risk associated with the left tail of our distribution. Even our safest investment, the bond portfolio will lose over \$2,500 5% of the time! The VARs of both equal weight and foreign heavy take a big leap from the bond heavy portfolio, telling us that these portfolios have a much higher chance of turning out poorly.

* Dispersion: The VAR is helpful information, but does not tell us the full story. For one thing, it ignores the worst case scenarios, but it also ignores all of the upside! We see the worst case scenarios through the minimum profit and get a feel for a best case scenario by looking at the max profit. Again, foreign-heavy portfolio does not look good. It gives us terrible worst case scenario, but a maximum profit that is not even as large a the equal weight.  Last, the mean absolute deviation(MAD) tells us what the average deviation is from the mean. This is probably the best one number summary for understanding the risk of each portfolio. 

* Expected Profit: Our average profits tell us what our expected outcomes are. The interesting point here is that the foreign-heavy portfolio only has a marginally higher expected profit than the bond heavy portfolio and much less than the equal weight. That's not a lot of compensation for all of the risk you are taking on! 

The key takeaways are that the foreign-heavy portfolio is almost certainly a bad idea. It provides little reward in the form of expected returns to compensate us for potentially devastating worst case losses, and higher variability. A more difficult decision is to make a determination between the bond-heavy and equal weighted portfolios.


### Stress Testing: Worst Case Scenarios

As a final examination of the risk in each portfolio, we have selected the worst performing periods for each portfolio and plotted out the path of total wealth that occurred over the 20 day period. The idea here, is to explore on an emotional level, how the worst case scenarios would have felt in real time. It can be easy to look at summary statistics in a calm setting and rationally explore which portfolio is best, but actually living through bear markets is a different story all together. 

```{r}

# Getting the wealth paths for each portfolio for the worst profit.
minports =  data.frame(all_ending_wealths %>%  group_by(Type) %>% filter(profit == min(profit)))
wealth_paths = data.frame(t(minports %>% select(-Type,-profit)))
colnames(wealth_paths) = c('Equal_Weight','Bond_Heavy', 'Foreign_Heavy')
wealth_paths$Day = 1:20


colors = c("Bond_Heavy" = "Green", "Equal_Weight" = "Blue", "Foreign_Heavy" = "Red")

ggplot(wealth_paths,aes(x=Day)) + geom_line(aes(y=Bond_Heavy, color='Bond_Heavy'),size=1.5) + geom_line(aes(y=Equal_Weight ,color='Equal_Weight'),size=1.5) + geom_line(aes(y=Foreign_Heavy,color='Foreign_Heavy'),size=1.5) + scale_y_continuous(labels = scales::dollar_format()) + labs(x='Day', y='Total Wealth', color='Legend', title = 'Wealth Path for the Worst Performing Periods')  + scale_color_manual(values = colors)
  
  


``` 
Ouch! These would have been a pretty painful experiences for just a 20 day period. The foreign-heavy portfolio stands out again for its remarkable ability to disappoint. This portfolio has a one day drop that would have been difficult to stomach in real time. Losing such a substantial portion of your wealth in a day would give even the thickest skin investors pause.

## Concluding Thoughts

Choosing a portfolio is no simple endeavor. What portfolio is "correct" can differ among people based on their particular circumstances. Time horizon, liquidity needs, and risk tolerance are among three of the top factors, but there can be many variables at play. What we can help to do, is provide information that should help investors make the most informed decision possible. In this particular case, we were able to essentially eliminate the foreign-heavy portfolio from consideration which will allow the investor to choose between the remaining portfolios, based on which one more closely aligns with their personal needs.


