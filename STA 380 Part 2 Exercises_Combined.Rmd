---
title: 'STA 380, Part 2: Exercises'
author: "Brandt"
date: "8/5/2021"
output:
  md_document:
    variant: markdown_github
---




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# output:
#   md_document:
#     variant: markdown_github

```



```{r, include=FALSE}
# Load libraries
set.seed(42)
library(readr)
library(dplyr)
library(tidyverse)
library(ggcorrplot)
library(moments)

library(mosaic)
library(quantmod)
library(foreach)

```


# Green Buildings

While the stats guru's analysis provided a good baseline for thinking about the issue, we believe his methodology fell short in several areas: particularly when it comes to understanding the potential for confounding variables.

After examining the data, we do not feel that there is sufficient evidence, on a monetary basis, to justify the additional investment to construct the building in line with green certification standards.
```{r, include=FALSE}

# Read in the data
greenbuildings <- read_csv("greenbuildings.csv")
greenbuildings = greenbuildings %>% select(-CS_PropertyID,-cluster) # Get rid of useless columns

# Convert categorical to factors and change binaries into 'Yes' and 'No'
data_plotting = greenbuildings

for (col_name in colnames(data_plotting)) {
  data = data_plotting[[col_name]]
  uniques = length(unique(data))
  if ( uniques <=2) {
    data = ifelse(data == 1,'Yes','No')
    data_plotting[[col_name]] <- factor(data)
  }
}



```

## Data Cleaning:

First, we can address the data cleaning aspect of the analysis. Are there any adjustments that should be made to the raw data se? The excel guru certainly felt that a certain amount of scrubbing should take place. He decided that because some of the buildings had low occupancy rates they should be excluded from the analysis due to their "weirdness". To explore the validity of this scrubbing we examined the data points that the guru proposes we remove, we manually inspect these observations and we do not find any other "weirdness" associated with these points that would indicate they should be removed. There are 215 data points with leasing rates less than 10 or 2.7% of the original data set. Without finding any reasonable justification, we decide not to remove these observations as we feel our bias should be towards data preservation.

```{r,include=FALSE}
# We want to understand what's going on with those data points he's scrubbing.

low_occupany = greenbuildings %>% filter(leasing_rate < 10)
other = greenbuildings %>% filter(leasing_rate >= 10)

# None of the values seem too out of control to me. Just that they may be a bit older buildings.
# Less than 10 seems pretty arbitrary though. So I'm leaning towards keeping it all.
# Might be that those buildings just get rented at weird times of the year or something.
# Either way, removing those data points or keeping them doesn't seem to change our conclusion much

summary(greenbuildings)
summary(low_occupany)

dim(low_occupany)

```

## Mean vs Median: Who's in Charge?
*Note: For the purposes of presentation clarity, we have converted all categorical, binary variables from "1", "0" to "Yes","No".*

The guru decided to use the median, over the mean in his analysis and we feel this approach is justified. Support for this position can be seen in the below histogram which depicts the distribution of rents. The rents are clearly right skewed, with a few points that lie far into the right tail. The vertical, blue line indicates the median value, and the vertical red line indicates the mean. We maintain that the appropriate statistic for our purposes is the median, unless there is some justification or reasoning that would indicate that this newly constructed building will be out of the ordinary. From here on, we will confine the majority of our analysis to looking at just the median.
```{r}
hist(greenbuildings$Rent, breaks = 50,xlab='Rent',main='Histogram of Rent')
rent_median = median(greenbuildings$Rent)
rent_mean = mean(greenbuildings$Rent)
rent_skew = skewness(greenbuildings$Rent)
abline(v=rent_median,lwd=2,col='blue')
abline(v=rent_mean,lwd=2,col='red')
text(100,1000, 'Mean = 28.42 \n Median = 25.16 \n Skew = 3.49')

```

## Big Picture: Green vs Non-Green
Now, as a starting point we can compare the median rent for green buildings vs non-green buildings. 
```{r}

data_plotting %>% group_by(green_rating) %>%  summarise(Median_Rent = median(Rent)) %>% ggplot(aes(x=green_rating,y=Median_Rent,fill=green_rating)) +
  geom_col() + geom_text(aes(label=Median_Rent),vjust=1.5,color='white') + labs(title = 'Median Rent by Greeness') + coord_cartesian(ylim=c(0,30)) + scale_y_continuous(breaks=seq(0,30,5))


```
The median rent is certainly larger for green buildings vs non green buildings: \$27.60 per square foot for green buildings vs \$25.00 for non-green buildings. But this doesn't really tell the full story. It is too much a leap of faith to claim that this rental difference is due solely to the building's green rating. We need to dig deeper to understand the data further and perhaps discover that the higher median rent differential could be attributed to another variable.


## Confounders

We need to do some basic exploration of our data set beyond what we have already done with a goal of understanding how a buildings green rating is related to both rent and other variables. You might hypothesize that green buildings are simply associated with other factors that are really driving the difference in the median rental value. "Going Green" is a newer phenomenon so we might expect that the majority of buildings that have green certifications are newer buildings and that this newness is what drives their rent higher. Perhaps buildings that are built with green certification standard in mind are also built with higher quality overall and that this higher quality, indicated  by building class, is what is determining rent dispersion. We must examine the data for the possibility of these confounders.

To get a feel for the potential interactions between variables in the data, we plot a correlation matrix.
```{r}


data_no_nas = na.omit(greenbuildings) # remove na's from employment
# data_no_employ = greenbuildings %>% select(-empl_gr)
# ggcorrplot(cor(data_no_employ), hc.order = TRUE, outline.color = "white")

corry_matrix = cor(data_no_nas)
ggcorrplot(corry_matrix, hc.order = TRUE, outline.color = "white") + labs(title='Correlation Matrix')


```

There are lots of interesting relationships displayed here, but we would like to focus on a few that provide interesting information to the question at hand and test our hypothesized confounders: Age and Building Class.  


### Age

First, examining the distribution of Age by green and non-green buildings, it's clear that green buildings do tend to be younger. 
```{r}


ggplot(data_plotting) + geom_boxplot(aes(x=green_rating,y=age, fill=green_rating)) + labs(title = 'Age Distribution by Greenness')


```

We know that green buildings tend to be younger, but do younger buildings command a rent premium? To uncover a potential relationship here we create a new variable 'younger' that indicates if the building is below the median age of all buildings in our data set. This will allow us to control for the rent between young and old buildings:
```{r}
med_age = median(data_plotting$age)
data_plotting <- data_plotting %>% mutate(younger = ifelse(age <= med_age,'Yes','No'))
# data_plotting$newer = factor(data_plotting$younger)

data_plotting %>% group_by(younger) %>%  summarise(Median_Rent = median(Rent)) %>% ggplot() +
  geom_col(aes(x=younger,y=Median_Rent,fill=younger)) + labs(title = 'Median Rent by Age') + coord_cartesian(ylim=c(0,30)) + scale_y_continuous(breaks=seq(0,30,5))

```
We can see that younger buildings do have a higher median rent than older buildings. This should cast some doubt on the case for the green premium. We know green buildings tend to be younger and we know younger buildings tend to have a higher rent. How can we untangle this!?


We'll dig further by breaking down median rent by both green rating and age:

```{r}
data_plotting %>% group_by(green_rating,younger) %>%  summarise(Median_Rent = median(Rent), count = n()) %>% ggplot(aes(x=younger,y=Median_Rent,fill=green_rating)) + geom_col(position = 'dodge',color='black') + labs(title = 'Median Rent by Age & Greenness') + scale_y_continuous(breaks=seq(0,30,5))
```

Interesting results. In both younger and older buildings, those that are green have a higher median rent than those that are not green. This lends a bit of credence to the green premium. 

One intriguing point is that green buildings command a much higher premium in older buildings. For our purposes of determining the premium for the newly constructed building; however, the median rent differential among younger buildings is more relevant. In this category the premium is much smaller and we do not feel as confident in claiming the premium is significant and not due to chance or other confounders.


### Class

What about class? We hypothesized that perhaps green buildings just happen to be built of a higher quality and thus higher class. We can see the evidence of this in the below plot. The majority of green buildings are also class A buildings.

```{r}
green_only = data_plotting %>% filter(green_rating == "Yes")

ggplot(data=green_only, aes(x=class_a, fill=class_a)) + geom_bar(color='black') + labs(title = 'Count of Class A within Greenness')

```

Now we show a breakdown similar to Age, that allows us to control for being a class A building and examine the median of green vs non-green.

```{r}
data_plotting %>% group_by(green_rating,class_a) %>%  summarise(Median_Rent = median(Rent), count = n()) %>% ggplot(aes(x=class_a,y=Median_Rent, fill=green_rating)) + geom_col(position = 'dodge',color='black') + labs(title = 'Median Rent by Class A & Greenness')  + scale_y_continuous(breaks=seq(0,30,5))


```

Class A is the winner in terms of rent, which does not come as a large surprise; we expect higher quality buildings to rent for more. There does appear to be a small advantage within each category for green buildings, but the dominant driver of rent here is the class. 




```{r}
## Other Insights
#We would also like to touch on two additional insights.

### Certification Choice
# 
# new_fram = data_plotting %>% filter(LEED == 'Yes'|Energystar == 'Yes')
# new_fram
# data_plotting %>% group_by(LEED,Energystar) %>% summarise(Median_Rent = median(Rent))
# 
# data_plotting %>% group_by(green_rating,class_a) %>%  summarise(Median_Rent = median(Rent), count = n()) %>% ggplot(aes(x=class_a,y=Median_Rent, fill=green_rating)) + geom_col(position = 'dodge',color='black') + labs(title = 'Median Rent by Class A & Greenness')  + scale_y_continuous(breaks=seq(0,30,5))

```



## Neighbor Rent

We also decided to investigate the relationship between the rent of other buildings in the local area with the rent of a particular building. Our correlation matrix gave us a strong positive association and we are always told that location is paramount when it comes to real estate. Below, you can see the Cluster Rent, Rent pairs plotted along with a fitted, single-predictor, regression line. The association between local building rents and rent appears to be strong indeed although the variance does increase as the cluster rent increases.

```{r}

ggplot(data_plotting,aes(x=cluster_rent,y=Rent)) + geom_point() + stat_smooth(method=lm,level=.95) + labs(title = 'Positive Association Between Rent of Cluster and Rent')

```


## Regression Model
As a final check on the analysis done so far, we run a multi-variable regression model with all of our independent variables. Our primary goal with this model is to validate and check the conclusions we have already made and ground our analysis with some numerical precision. The summary is depicted below: 


```{r}

model_data = greenbuildings %>% select(-total_dd_07) # Remove total because it is just a combination of two other vars.
# model_data = greenbuildings %>% select(-cd_total_07,-hd_total07)
lm_model = lm(Rent~.,data=model_data)
summary(lm_model)


```

Key takeaways from the model output. Age has a negative coefficient, class_a has a positive coefficient, and cluster rent has a positive coefficient. These match up with our previous analysis. Green Rating has a slightly positive coefficient of .5, but it is not statistically significant at the .05 level meaning that when we control for all of the factors in the data, the positive impact of green rating does not exhibit strong enough evidence that it truly exists. Another factor worth considering is that that the Energy Star coefficient is actually negative. This is interesting because if the developer does consider go ahead with a green certification, they would need to decide if they should get one or both certifications. Though it is not statistically significant, we suggest they prioritize compliance with the LEED standard. 

## Conclusion 

Our final recommendation is: based on the data currently available, we do not recommend the developer should invest in the construction necessary to achieve a green certification. The data does not provide strong enough evidence to indicate that the green premium exists. The $ 5 million dollars could be more appropriately invested elsewhere.



